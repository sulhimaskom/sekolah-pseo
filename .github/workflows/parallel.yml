name: parallel

on:
  push:
    branches:
      - main
  schedule:
    - cron: "0 */4 * * *"
  workflow_dispatch:

permissions:
  contents: write
  issues: write
  pull-requests: write
  actions: write
  id-token: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

jobs:

  # ================================================================
  # STAGE 1 â€” ARCHITECT (THE BRAIN)
  # ================================================================
  architect:
    name: "Architect: Strategy & Triage"
    runs-on: ubuntu-24.04-arm

    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      IFLOW_API_KEY: ${{ secrets.IFLOW_API_KEY }}
      CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
      CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
      GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
      API_KEY: ${{ secrets.GEMINI_API_KEY }}

    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0
      - name: Check Open Issue Count
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          COUNT=$(gh issue list --state open --json number --jq length)
          echo "Open issues: $COUNT"      
          if [ "$COUNT" -gt 10 ]; then
            echo "ðŸš« Issue count > 10. Skipping Architect stage."
            exit 0
          fi
          
      - uses: actions/cache@v4
        with:
          path: |
            ~/.opencode
            ~/.npm
          key: opencode-${{ runner.os }}-${{ hashFiles('**/package-lock.json') }}-v1
          restore-keys: |
            opencode-${{ runner.os }}-v1

      - name: Configure Git
        run: |
          git config --global user.name "${{ github.actor }}"
          git config --global user.email "${{ github.actor_id }}+${{ github.actor }}@users.noreply.github.com"

      - uses: actions/setup-node@v4
        with:
          node-version: "20"

      - run: npm ci || true

      - name: Install OpenCode
        run: |
          curl -fsSL https://opencode.ai/install | bash -s -- --version 1.2.15
          echo "$HOME/.opencode/bin" >> $GITHUB_PATH

      - name: Architect Intelligence Cycle
        timeout-minutes: 45
        run: |
            timeout -k 1m 45m opencode run /ulw-loop "
            IF Github issue_count > 10 THEN enter MANAGER MODE. IF Github issue_count < 10 THEN enter CREATOR MODE.

            // MANAGER MODE
            - Audit all existing issues:
                - Verify each issue is still relevant.
                - Ensure labels match the correct layer and priority.
                - Remove duplicate issues or merge overlapping scopes.

            // CREATOR MODE
            You are a Fully Autonomous System Orchestrator.
            
            SYSTEM TARGET:
            Fullstack serverless production-grade application.
            
            YOU LEAD AI AGENT TEAM:
            - RnD
            - Product-Architect
            - AI-Agent-Engineer
            - Backend-Engineer
            - Frontend-Engineer
            - UI-UX-Engineer
            - Platform-Engineer
            - Security-Engineer
            - Quality-Assurance
            - DX-Engineer
            - Technical-Writer
            - User-Story-Engineer
            - Growth-Innovation-Strategist
            
            OBJECTIVE:
            Continuously evolve the system across:
            - Architecture integrity
            - Backend & frontend quality
            - Infrastructure & DevOps
            - Security posture
            - Testing coverage
            - Documentation clarity
            - Developer Experience (DX)
            - Product usability
            - Strategic innovation
            
            PRIMARY TASK:
            1. Perform deep full-repository audit.
            2. Detect:
               - Inefficiencies
               - Architectural drift
               - Tech debt
               - Missing or weak tests
               - Security gaps
               - DX friction
               - UX friction
            3. Identify hidden leverage & innovation opportunities.
            4. Create atomic, non-overlapping GitHub Issues.
            5. Maintain docs/blueprint.md as the architectural constitution.
            
            WORK PRINCIPLES:
            - Production-grade discipline
            - Zero redundancy
            - Clean architecture boundaries
            - High cohesion, low coupling
            - Security-first mindset
            - Test-first validation
            - Performance-aware design
            - Simplicity over novelty
            - Avoid overengineering
            - Prefer leverage over feature bloat
            
            INNOVATION DIRECTIVE:
            Every cycle MUST include at least one:
            - UX simplification proposal
            - Automation opportunity
            - AI-native feature idea
            - Performance breakthrough
            - Workflow optimization
            - 10x leverage improvement
            
            Innovation proposals must include:
            - Clear hypothesis
            - Measurable expected outcome
            - Rollback strategy
            - Maintenance cost evaluation
            
            STRICT PHASE:
            ANALYZE â†’ PLAN â†’ DESIGN â†’ REVIEW â†’ VERIFY â†’ DELIVER
            
            No phase skipping.
            No phase merging.
            
            ISSUE RULES:
            - One issue = one problem = one owner agent
            - No duplicate scope
            - No vague language
            - No overlapping responsibility
            - Root-cause oriented
            - Measurable acceptance criteria required
            
            ISSUE FORMAT:
            
            Title:
            Label:
            Layer: (Architecture | Backend | Frontend | Infra | Security | DX | QA | Docs | Product | Innovation)
            Owner Agent:
            Problem Statement:
            Root Cause:
            Proposed Solution:
            Acceptance Criteria:
            - [ ]
            - [ ]
            - [ ]
            Definition of Done:
            - Code updated
            - Tests added/updated
            - Docs updated (if relevant)
            - blueprint.md updated (if architectural)
            Impact Surface: (User | System | DevEx | Security | Performance | Growth)
            Priority: High | Medium | Low
            
            ANTI-DRIFT PROTOCOL:
            Before creating an issue:
            - Check for similar scope
            - Merge or extend if overlapping
            - Avoid refactor without measurable gain
            
            OPTIMIZATION BALANCE:
            70% Stability & System Integrity
            30% Innovation & Strategic Advantage
            
            Never create duplicate issues.
            Never create vague issues.
            Never overlap responsibility.
            Never introduce complexity without measurable gain.
            Optimize for long-term maintainability and strategic leverage.
            " \
            --model iflowcn/glm-4.6 \
            --share false --thinking false

  # ================================================================
  # STAGE 2 â€” SPECIALISTS (THE MUSCLE)
  # ================================================================
  specialists:
    name: "Specialist: ${{ matrix.role }}"
    needs: architect
    runs-on: ubuntu-24.04-arm
    continue-on-error: true

    strategy:
      fail-fast: false
      matrix:
        role:
          - RnD
          - Product-Architect
          - ai-agent-engineer
          - backend-engineer
          - frontend-engineer
          - ui-ux-engineer
          - platform-engineer
          - security-engineer
          - quality-assurance
          - DX-engineer
          - technical-writer
          - user-story-engineer
          - Growth-Innovation-Strategist

    steps:
      - uses: actions/checkout@v6
    
      - name: Skip if Open PR Exists
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          COUNT=$(gh pr list --state open --json number --jq length)
          if [ "$COUNT" -gt 0 ]; then
            echo "ðŸš« Open PR exists. Skipping."
            exit 0
          fi

      - name: Configure Git
        run: |
          git config --global user.name "${{ github.actor }}"
          git config --global user.email "${{ github.actor_id }}+${{ github.actor }}@users.noreply.github.com"

      - uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install OpenCode
        run: |
          curl -fsSL https://opencode.ai/install | bash -s -- --version 1.2.15
          echo "$HOME/.opencode/bin" >> $GITHUB_PATH

      - name: Execute Specialist Work
        timeout-minutes: 45
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          IFLOW_API_KEY: ${{ secrets.IFLOW_API_KEY }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          echo "ðŸš€ Specialist ${{ matrix.role }} executing"

          timeout -k 1m 45m opencode run /ulw-loop "
          You are Autonomous ${{ matrix.role }} Specialist.

          DOMAIN: ${{ matrix.role }}
          OBJECTIVE:
          Deliver small, safe, measurable improvements strictly inside your domain.
          
          STRICT PHASE:
          INITIATE â†’ PLAN â†’ IMPLEMENT â†’ VERIFY â†’ SELF-REVIEW â†’ SELF EVOLVE â†’ DELIVER (PR)
          
          No phase skipping.
          No phase merging.
            
          INITIATE:
          - If open pr with label ${{ matrix.role }} exist â†’ ensure up to date with default branch, review, fix if necessary and comment on that pr.
          - If Issue exists â†’ execute.
          - If none issue or pr â†’ proactive scan limited to domain.
          - If nothing valuable â†’ proactive scan repository health and efficiency limited to domain.

          SELF EVOLVE:
          - Quick check other agents long time memory to improve teammate and work efficienty
          - You improve and evolve over time
          - Maintain docs/${{ matrix.role }}.md as your longtime memory

          PR REQUIREMENTS:
          - Label: ${{ matrix.role }}
          - Linked to issue if any
          - Up to date with default branch
          - No conflict
          - Build/lint/test success
          - ZERO warnings
          - Small atomic diff
          
          Never refactor unrelated modules.
          Never introduce unnecessary abstraction.
          " \
          --model iflowcn/glm-4.6 \
          --agent ${{ matrix.role }} \
          --share false --thinking false

  # ================================================================
  # STAGE 3 â€” FIXER
  # ================================================================
  Fixer:
    name: "Fixer"
    needs: specialists
    runs-on: ubuntu-24.04-arm

    steps:
      - uses: actions/checkout@v6

      - name: Configure Git
        run: |
          git config --global user.name "${{ github.actor }}"
          git config --global user.email "${{ github.actor_id }}+${{ github.actor }}@users.noreply.github.com"

      - uses: actions/setup-node@v4
        with:
          node-version: "20"

      - run: npm ci || true

      - name: Install OpenCode
        run: |
          curl -fsSL https://opencode.ai/install | bash -s -- --version 1.2.15
          echo "$HOME/.opencode/bin" >> $GITHUB_PATH

      - name: Audit & Fix PRs
        timeout-minutes: 60
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          IFLOW_API_KEY: ${{ secrets.IFLOW_API_KEY }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          timeout -k 1m 45m opencode run /ulw-loop "
          You are Autonomous PR Fixer.

          Audit ALL non-merged PRs.
          For each PR:
          - Ensure up to date
          - No conflicts
          - Build/lint/test success
          - ZERO warnings
          - All CI green

          Fix minor issues automatically.
          Add detailed technical comments.
          DO NOT merge PR.
          " \
          --model iflowcn/glm-4.6 \
          --share false --thinking false

  # ================================================================
  # STAGE 4 â€” PR HANDLER
  # ================================================================
  PR-Handler:
    name: "PR-Handler"
    needs: Fixer
    runs-on: ubuntu-24.04-arm

    steps:
      - uses: actions/checkout@v6

      - name: Configure Git
        run: |
          git config --global user.name "${{ github.actor }}"
          git config --global user.email "${{ github.actor_id }}+${{ github.actor }}@users.noreply.github.com"

      - uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install OpenCode
        run: |
          curl -fsSL https://opencode.ai/install | bash -s -- --version 1.2.15
          echo "$HOME/.opencode/bin" >> $GITHUB_PATH

      - name: Merge Qualified PRs
        timeout-minutes: 60
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          IFLOW_API_KEY: ${{ secrets.IFLOW_API_KEY }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          timeout -k 1m 45m opencode run /ulw-loop "
          GOAL:
          Make every PR safely mergable and merge it without conflicts.
          
          PROCESS:
          1. Sort PRs by:
             a. created_at DESC (newest PR first)
             b. urgency (tie-breaker only):
                - Merge conflict present
                - CI failing
                - Ready to merge
                - Draft          
          2. For each PR (one at a time):
             - Checkout PR branch
             - Fetch latest DEFAULT_BRANCH
             - Rebase or merge DEFAULT_BRANCH INTO PR branch
             - Resolve conflicts ONLY if trivial and deterministic
               - If not trivial â†’ comment with explanation and CLOSE that PR
             - Run build and test suite
             - Fix:
               - Lint errors
               - Formatting issues
               - Minor test failures
             - Commit fixes directly to PR branch          
          3. Merge Conditions:
             ONLY merge if:
             - No conflicts
             - Build/lint/test success
             - ZERO warnings
             - All checks green
             - No security-sensitive change without review          
          4. After merge:
             - Close linked issues
             - Delete remote branch if policy allows
             - Log action
          " \
          --model iflowcn/glm-4.6 \
          --share false --thinking false
