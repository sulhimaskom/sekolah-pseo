name: data-freshness

on:
  # Weekly schedule - runs every Sunday at midnight UTC
  schedule:
    - cron: '0 0 * * 0'
  # Manual trigger for on-demand execution
  workflow_dispatch:
    inputs:
      skip_notification:
        description: 'Skip creating notification issue'
        type: boolean
        default: false
      force_rebuild:
        description: 'Force full rebuild after ETL'
        type: boolean
        default: false

permissions:
  contents: write
  issues: write

jobs:
  data-freshness:
    name: Data Freshness Monitor
    runs-on: ubuntu-24.04-arm
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 1
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Check raw data existence
        id: check_data
        run: |
          if [ -f "external/raw.csv" ]; then
            echo "raw_data_exists=true" >> $GITHUB_OUTPUT
            echo "raw_records=$(wc -l < external/raw.csv)" >> $GITHUB_OUTPUT
          else
            echo "raw_data_exists=false" >> $GITHUB_OUTPUT
            echo "raw_records=0" >> $GITHUB_OUTPUT
          fi

      - name: Run ETL and generate quality report
        id: etl
        if: steps.check_data.outputs.raw_data_exists == 'true'
        run: |
          npm run etl 2>&1 | tee etl-output.txt

          # Extract quality metrics from ETL output
          TOTAL_RECORDS=$(grep "Processed" etl-output.txt | grep -oP '\d+(?= valid)' || echo "0")
          echo "total_records=$TOTAL_RECORDS" >> $GITHUB_OUTPUT

          # Check for duplicates
          if grep -q "Duplicate NPSN" etl-output.txt; then
            echo "has_duplicates=true" >> $GITHUB_OUTPUT
          else
            echo "has_duplicates=false" >> $GITHUB_OUTPUT
          fi

      - name: Read previous freshness data
        id: previous_data
        run: |
          if [ -f ".data-freshness.json" ]; then
            echo "previous_exists=true" >> $GITHUB_OUTPUT
            cat .data-freshness.json
          else
            echo "previous_exists=false" >> $GITHUB_OUTPUT
            echo '{"first_run": true}' > previous-data.json
          fi

      - name: Calculate changes and update freshness
        id: freshness
        run: |
          CURRENT_DATE=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          CURRENT_RECORDS=${{ steps.etl.outputs.total_records || '0' }}

          # Create freshness JSON
          cat > .data-freshness.json << EOF
          {
            "last_etl_run": "$CURRENT_DATE",
            "last_etl_date": "$(date -u +%Y-%m-%d)",
            "record_count": $CURRENT_RECORDS,
            "has_duplicates": ${{ steps.etl.outputs.has_duplicates || 'false' }},
            "workflow_run_id": ${{ github.run_id }}
          }
          EOF

          cat .data-freshness.json

          # Compare with previous if exists
          if [ "${{ steps.previous_data.outputs.previous_exists }}" = "true" ]; then
            # Parse previous record count from previous-data.json
            PREV_RECORDS=$(node -e "console.log(require('./previous-data.json').record_count || 0)")
            echo "previous_record_count=$PREV_RECORDS" >> $GITHUB_OUTPUT
            
            # Calculate change percentage
            if [ "$PREV_RECORDS" -gt 0 ]; then
              CHANGE=$(( (CURRENT_RECORDS - PREV_RECORDS) * 100 / PREV_RECORDS ))
              echo "change_percentage=$CHANGE" >> $GITHUB_OUTPUT
              
              # Detect significant changes (>5% difference)
              if [ $CHANGE -gt 5 ] || [ $CHANGE -lt -5 ]; then
                echo "significant_change=true" >> $GITHUB_OUTPUT
              else
                echo "significant_change=false" >> $GITHUB_OUTPUT
              fi
            else
              echo "change_percentage=0" >> $GITHUB_OUTPUT
              echo "significant_change=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "previous_record_count=0" >> $GITHUB_OUTPUT
            echo "change_percentage=0" >> $GITHUB_OUTPUT
            echo "significant_change=false" >> $GITHUB_OUTPUT
          fi

      - name: Commit freshness data
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add .data-freshness.json
          git diff --staged --quiet || git commit -m "Update data freshness metadata"

      - name: Push changes
        uses: ad-m/github-push-action@master
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          branch: ${{ github.ref }}

      - name: Create notification on issues
        if: >-
          (steps.freshness.outputs.significant_change == 'true' 
          || steps.etl.outputs.has_duplicates == 'true'
          || steps.check_data.outputs.raw_data_exists == 'false')
          && github.event_name != 'workflow_dispatch'
        run: |
          # Create issue title and body
          ISSUE_TITLE="Data Quality Alert - $(date -u +%Y-%m-%d)"

          ISSUE_BODY="## Data Freshness Report

          **Run Date:** $(date -u +%Y-%m-%dT%H:%M:%SZ)
          **Workflow:** #${{ github.run_number }}

          ---

          ### Current Status

          | Metric | Value |
          |--------|-------|
          | Raw Data Exists | ${{ steps.check_data.outputs.raw_data_exists }} |
          | Total Records | ${{ steps.etl.outputs.total_records || 'N/A' }} |
          | Has Duplicates | ${{ steps.etl.outputs.has_duplicates || 'false' }} |
          | Significant Change | ${{ steps.freshness.outputs.significant_change }} |
          | Change % | ${{ steps.freshness.outputs.change_percentage }}% |

          ---

          ### Previous Run

          - Record Count: ${{ steps.freshness.outputs.previous_record_count }}

          ---

          ### Actions Required

          ${{ steps.check_data.outputs.raw_data_exists == 'false' && '- âš ï¸ No raw data found - external data source may be unavailable' || '' }}
          ${{ steps.etl.outputs.has_duplicates == 'true' && '- âš ï¸ Duplicate NPS datasetN values detected in' || '' }}
          ${{ steps.freshness.outputs.significant_change == 'true' && '- ðŸ“Š Significant data change detected (>5%)' || '' }}

          _This issue was automatically created by the data-freshness workflow._"

          gh issue create \
            --title "$ISSUE_TITLE" \
            --body "$ISSUE_BODY" \
            --label "platform-engineer,data-quality"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Summary
        run: |
          echo "## Data Freshness Summary"
          echo ""
          echo "| Metric | Value |"
          echo "|--------|-------|"
          echo "| Raw Data Exists | ${{ steps.check_data.outputs.raw_data_exists }} |"
          echo "| Raw Records | ${{ steps.check_data.outputs.raw_records }} |"
          echo "| Processed Records | ${{ steps.etl.outputs.total_records || 'N/A' }} |"
          echo "| Has Duplicates | ${{ steps.etl.outputs.has_duplicates || 'false' }} |"
          echo "| Change % | ${{ steps.freshness.outputs.change_percentage }}% |"
          echo "| Significant Change | ${{ steps.freshness.outputs.significant_change }} |"
