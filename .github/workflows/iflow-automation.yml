 iFlow CLI Automation Workflow
#
# This workflow orchestrates a suite of automated tasks using the
iFlow CLI GitHub Action.  The goal is to empower a solo developer
# to delegate issue triage, feature implementation, pull‑request
# reviews, code optimisation and security hardening to an AI agent.
# Each job leverages iFlow to analyse context, execute shell
# commands via the GitHub CLI (`gh`) and update the repository.
#
# To enable this workflow you must configure an `IFLOW_API_KEY` secret in
# your repository.  You may also want to create a personal access
# token with `repo`, `issues` and `pull_request` scopes and assign it
# to `GITHUB_TOKEN` if you need to push commits or open pull requests.

name: "iFlow CLI Automation"

# Trigger the workflow on various events.  You can customise these
# triggers to suit your development process.  By default the workflow
# will respond to issue and pull request events, scheduled maintenance,
# pushes to the default branch and manual dispatches.
on:
  # Handle new or reopened issues and comments to triage and optionally
  # implement features.  Comments allow maintainers to explicitly invoke
  # iFlow on a specific issue by mentioning "@iflow-cli /implement".
  issues:
    types: [opened, reopened]
  issue_comment:
    types: [created]

  # Review pull requests whenever they are opened, reopened or updated
  # (synchronised).  Maintainers can also trigger an additional review
  # by adding a comment containing "@iflow-cli /review" on the PR.
  pull_request:
    types: [opened, reopened, synchronize]
  pull_request_review_comment:
    types: [created]

  # Run optimisation and security hardening on pushes to the default
  # branch.  Adjust the branch pattern if your default branch is
  # something other than `main`.
  push:
    branches:
      - main

  # Schedule a nightly maintenance run at 02:00 UTC (09:00 Asia/Jakarta)
  # to perform architecture analysis, dependency updates and general
  # housekeeping.  Change the cron expression as needed.
  schedule:
    - cron: '0 2 * * *'

  # Allow manual triggers via the GitHub UI.  Maintainers can specify
  # issue or pull request numbers to process on demand.
  workflow_dispatch:
    inputs:
      issue_number:
        description: 'Optional: issue number to triage or implement'
        required: false
        type: number
      pr_number:
        description: 'Optional: pull request number to review or apply changes'
        required: false
        type: number

jobs:
  # Job: triage and optionally implement issues
  triage_issue:
    # Run only when triggered by issue events or manual dispatch with an issue number
    if: |
      github.event_name == 'issues' ||
      (github.event_name == 'issue_comment' &&
       contains(github.event.comment.body, '@iflow-cli /triage')) ||
      (github.event_name == 'workflow_dispatch' && inputs.issue_number)
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
      pull-requests: write
    defaults:
      run:
        shell: bash
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # Run iFlow CLI to classify the issue and apply labels.  When
      # maintainers comment with "@iflow-cli /implement", the same prompt
      # will also implement the requested feature by creating a branch,
      # committing changes and opening a pull request.  The API key is
      # sourced from repository secrets.  The `GITHUB_TOKEN` is passed
      # via environment so iFlow can authenticate to GitHub CLI commands.
      - name: "Run iFlow CLI for Issue Triage and Implementation"
        uses: iflow-ai/iflow-cli-action@v2.1.0
        id: iflow_issue
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_TITLE: ${{ github.event.issue.title || 'manual' }}
          ISSUE_BODY: ${{ github.event.issue.body || '' }}
          ISSUE_NUMBER: ${{ github.event.issue.number || inputs.issue_number }}
          REPOSITORY: ${{ github.repository }}
        with:
          api_key: ${{ secrets.IFLOW_API_KEY }}
          timeout: '7200'
          debug: 'false'
          prompt: |
            ## Role
            You are an AI developer and project manager responsible for
            triaging issues and, when requested, implementing features or
            bug fixes described in those issues.  Operate entirely
            through the GitHub CLI (`gh`) and the local git repository.

            ## Context
            * The current issue title is "${{ env.ISSUE_TITLE }}".
            * The issue body contains:
              "${{ env.ISSUE_BODY }}".
            * The issue number is `${{ env.ISSUE_NUMBER }}` in
              repository `${{ env.REPOSITORY }}`.
            * You have access to `gh` commands authenticated with
              `${{ env.GITHUB_TOKEN }}` and a checked‑out repository.

            ## Tasks
            1. List existing labels using `gh label list` and classify the
               issue by kind (bug, enhancement, documentation, cleanup, etc.)
               and priority (p0–p3).  Apply labels using
               `gh issue edit "$ISSUE_NUMBER" --add-label` and remove
               any `status/needs-triage` label if present.
            2. Determine whether the issue requires an implementation.  An
               implementation should be performed only if any of the
               following is true:
               * The issue title or body contains phrases like
                 "fix", "implement", "add", "create", "update", or
                 "security".
               * The triggering comment from a maintainer contains the
                 phrase `@iflow-cli /implement`.
            3. If implementation is required:
               a. Create a new git branch named
                  `iflow/issue-${{ env.ISSUE_NUMBER }}` using `git checkout -b`.
               b. Analyse the repository to identify the files to modify or
                  create in order to resolve the issue.  Generate
                  production‑ready code that adheres to existing coding
                  conventions and includes comments where helpful.
               c. Make the necessary changes directly in the working tree.
               d. Stage and commit the changes with a meaningful message
                  referencing the issue number (e.g., `git commit -am
                  "Fix #${{ env.ISSUE_NUMBER }}: <brief summary>`).
               e. Push the branch to the remote using
                  `git push origin iflow/issue-${{ env.ISSUE_NUMBER }}`.
               f. Open a pull request via
                  `gh pr create --fill --base main --head
                  iflow/issue-${{ env.ISSUE_NUMBER }} --title
                  "Resolve #${{ env.ISSUE_NUMBER }}" --body
                  "This PR implements changes requested in #${{ env.ISSUE_NUMBER }}."`.

            ## Guidelines
            * Use only existing labels; do not create new labels.
            * Keep implementations small and focused on the issue at hand.
            * Never expose secrets or sensitive information.
            * Reference environment variables as `${VAR}` within shell commands.
            * When unsure, prioritise clarity and maintainability over
              premature optimisation.

  # Job: review pull requests and provide feedback
  review_pr:
    # Run only when triggered by pull request events or manual dispatch with a PR number
    if: |
      github.event_name == 'pull_request' ||
      (github.event_name == 'pull_request_review_comment' &&
       contains(github.event.comment.body, '@iflow-cli /review')) ||
      (github.event_name == 'workflow_dispatch' && inputs.pr_number)
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    defaults:
      run:
        shell: bash
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          # Fetch all history so diffs contain full context
          fetch-depth: 0

      - name: "Run iFlow CLI for Pull Request Review"
        uses: iflow-ai/iflow-cli-action@v2.1.0
        id: iflow_review
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number || inputs.pr_number }}
          BASE_REF: ${{ github.event.pull_request.base.ref || 'main' }}
          HEAD_REF: ${{ github.event.pull_request.head.ref || '' }}
          REPOSITORY: ${{ github.repository }}
        with:
          api_key: ${{ secrets.IFLOW_API_KEY }}
          timeout: '7200'
          debug: 'false'
          prompt: |
            ## Role
            You are an AI code reviewer tasked with analysing the changes in
            a pull request.  Provide constructive feedback and identify
            opportunities for improvement.

            ## Context
            * Pull request number: `${{ env.PR_NUMBER }}`
            * Base branch: `${{ env.BASE_REF }}`
            * Head branch: `${{ env.HEAD_REF }}`
            * Repository: `${{ env.REPOSITORY }}`

            ## Tasks
            1. Use `gh pr checkout $PR_NUMBER` to check out the PR branch.
            2. Use `git diff $BASE_REF...$HEAD_REF` to analyse the changes.
            3. Evaluate code quality, potential security vulnerabilities,
               performance issues, and adherence to the project's style.
            4. Suggest improvements such as refactoring, added tests,
               documentation updates, or dependency upgrades.
            5. Post a summary comment on the pull request using
               `gh pr comment $PR_NUMBER --body "<your review>"`.

            ## Guidelines
            * Be polite and constructive; focus on actionable insights.
            * If you detect a critical issue that blocks merging, clearly
              state it and explain why.
            * Do not merge the PR yourself; leave that decision to human
              maintainers.

  # Job: apply PR review suggestions when requested
  apply_pr_changes:
    # Run when a maintainer requests applying suggested changes via a PR comment
    if: |
      github.event_name == 'pull_request_review_comment' &&
      contains(github.event.comment.body, '@iflow-cli /apply-review')
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    defaults:
      run:
        shell: bash
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: "Run iFlow CLI to Apply Review Changes"
        uses: iflow-ai/iflow-cli-action@v2.1.0
        id: iflow_apply_review
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          COMMENT_ID: ${{ github.event.comment.id }}
        with:
          api_key: ${{ secrets.IFLOW_API_KEY }}
          timeout: '7200'
          debug: 'false'
          prompt: |
            ## Role
            You are an AI developer tasked with implementing the changes
            suggested in a pull request review comment.

            ## Context
            * Pull request number: `${{ env.PR_NUMBER }}`
            * Review comment ID: `${{ env.COMMENT_ID }}`
            * You have the repository checked out and the `GITHUB_TOKEN`
              available for authentication.

            ## Tasks
            1. Fetch the content of the review comment using
               `gh api repos/${{ github.repository }}/pulls/${{ env.PR_NUMBER }}/comments/${{ env.COMMENT_ID }}`
               and extract the suggested improvements.
            2. Identify the files and lines referenced in the comment and
               apply the suggested changes to the codebase.  Ensure that
               the modifications preserve existing functionality and pass
               linters.
            3. Commit the changes with a clear message such as
               `git commit -am "Apply review suggestions from comment ${${ env.COMMENT_ID }}"`.
            4. Push to the PR branch using `git push`.
            5. Optionally acknowledge the review by replying to the comment
               via `gh pr comment $PR_NUMBER --body "Applied suggested changes."`.

            ## Guidelines
            * Do not introduce unrelated changes; focus only on the
              suggested modifications.
            * If the suggested change is unclear or harmful, skip it and
              state why in the reply comment.

  # Job: nightly maintenance for optimisation and security
  maintenance:
    # Run on the scheduled cron or manual dispatch without issue/pr inputs
    if: |
      github.event_name == 'schedule' ||
      (github.event_name == 'push' && github.ref == 'refs/heads/main') ||
      (github.event_name == 'workflow_dispatch' && !inputs.issue_number && !inputs.pr_number)
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    defaults:
      run:
        shell: bash
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: "Run iFlow CLI for Repository Maintenance"
        uses: iflow-ai/iflow-cli-action@v2.1.0
        id: iflow_maintenance
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPOSITORY: ${{ github.repository }}
        with:
          api_key: ${{ secrets.IFLOW_API_KEY }}
          timeout: '10800'
          debug: 'false'
          prompt: |
            ## Role
            You are an AI architect and security engineer performing
            comprehensive maintenance on the repository.

            ## Tasks
            1. Analyse the entire codebase for performance bottlenecks,
               deprecated APIs, and security vulnerabilities.  Use tools
               such as `cargo audit`, `npm audit`, or language‑specific
               static analysers if available.  For example, run
               `npm audit --json` for JavaScript projects or `cargo audit`
               for Rust projects.
            2. Generate optimised code or refactors where necessary to
               improve readability, performance and modularity.  Ensure
               that all changes remain backward‑compatible.
            3. Consolidate duplicate or dead code.  Remove unused files and
               dependencies.
            4. Upgrade dependencies to the latest stable versions,
               respecting semantic versioning constraints.  Use
               `npm update`, `cargo update`, or similar commands as
               appropriate.  Document any breaking changes in the PR body.
            5. Create a new branch named `iflow/maintenance/${{ github.run_id }}`.
            6. Commit all modifications with a descriptive message like
               "Maintenance: optimise and secure codebase".
            7. Push the branch to the remote repository and open a pull
               request against the default branch with a summary of the
               changes.  Use `gh pr create --fill` to auto‑populate the PR
               details.

            ## Guidelines
            * Respect existing coding standards and project structure.
            * Group related changes into cohesive commits.  Avoid mixing
              unrelated updates in a single commit.
            * Where automated tooling produces a large number of changes
              (e.g., dependency upgrades), summarise the impact in the
              PR description.
