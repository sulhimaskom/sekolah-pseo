name: "ðŸ¤– iFlow CLI Automation"

on:
  issues:
    types: [opened, reopened]
  issue_comment:
    types: [created]
  pull_request:
    types: [opened, reopened, synchronize]
  pull_request_review_comment:
    types: [created]
  push:
    branches:
      - main
  schedule:
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      issue_number:
        description: 'Optional: issue number to triage or implement'
        required: false
        type: number
      pr_number:
        description: 'Optional: pull request number to review or apply changes'
        required: false
        type: number

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.run_id }}
  cancel-in-progress: false

jobs:
  triage_issue:
    if: |
      github.event_name == 'issues' ||
      (github.event_name == 'issue_comment' &&
       contains(github.event.comment.body, '@iflow-cli /triage')) ||
      (github.event_name == 'workflow_dispatch' && inputs.issue_number)
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
      pull-requests: write
    defaults:
      run:
        shell: bash
    steps:
      - uses: actions/checkout@v4
      - name: "Run iFlow CLI for Issue Triage and Implementation"
        uses: iflow-ai/iflow-cli-action@v2.1.0
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
          ISSUE_TITLE: ${{ github.event.issue.title || 'manual' }}
          ISSUE_BODY: ${{ github.event.issue.body || '' }}
          ISSUE_NUMBER: ${{ github.event.issue.number || inputs.issue_number }}
          REPOSITORY: ${{ github.repository }}
        with:
          api_key: ${{ secrets.IFLOW_API_KEY }}
          timeout: '7200'
          prompt: |
            ## Role
            You are an AI developer and project manager responsible for triaging issues and implementing features or bug fixes.

            ## Tasks
            - Label, implement, and open PR if needed.

  review_pr:
    if: |
      github.event_name == 'pull_request' ||
      (github.event_name == 'pull_request_review_comment' &&
       contains(github.event.comment.body, '@iflow-cli /review')) ||
      (github.event_name == 'workflow_dispatch' && inputs.pr_number)
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    defaults:
      run:
        shell: bash
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: "Run iFlow CLI for Pull Request Review"
        uses: iflow-ai/iflow-cli-action@v2.1.0
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number || inputs.pr_number }}
          BASE_REF: ${{ github.event.pull_request.base.ref || 'main' }}
          HEAD_REF: ${{ github.event.pull_request.head.ref || '' }}
          REPOSITORY: ${{ github.repository }}
        with:
          api_key: ${{ secrets.IFLOW_API_KEY }}
          timeout: '7200'
          prompt: |
            ## Role
            You are an AI code reviewer.

            ## Tasks
            - Checkout PR and review diff.
            - Post structured feedback comment.

  apply_pr_changes:
    if: github.event_name == 'pull_request_review_comment'
    runs-on: ubuntu-latest
    concurrency:
      group: apply-${{ github.event.pull_request.number }}-${{ github.event.comment.id }}
      cancel-in-progress: false
    permissions:
      contents: write
      pull-requests: write
    defaults:
      run:
        shell: bash
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: "Run iFlow CLI to Apply Review Changes (All Comments in Conversation)"
        uses: iflow-ai/iflow-cli-action@v2.1.0
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          COMMENT_ID: ${{ github.event.comment.id }}
          REPOSITORY: ${{ github.repository }}
        with:
          api_key: ${{ secrets.IFLOW_API_KEY }}
          timeout: '7200'
          prompt: |
            ## Role
            You are an autonomous AI maintainer.

            ## Context
            - PR: `${{ env.PR_NUMBER }}`
            - Comment ID: `${{ env.COMMENT_ID }}`
            - Repository: `${{ env.REPOSITORY }}`

            ## Steps
            1. Identify the conversation thread from the comment:
               `thread_id=$(gh api repos/${{ env.REPOSITORY }}/pulls/comments/${{ env.COMMENT_ID }} --jq '.in_reply_to_id // .id')`
            2. Fetch all comments in that conversation:
               `gh api repos/${{ env.REPOSITORY }}/pulls/${{ env.PR_NUMBER }}/comments --paginate --jq ".[] | select(.in_reply_to_id == $thread_id or .id == $thread_id)" > conversation.json`
            3. Analyse `conversation.json` to gather all technical instructions.
            4. Checkout the PR branch: `gh pr checkout $PR_NUMBER`.
            5. Apply all actionable changes derived from the full comment thread.
            6. Run quick checks (lint/tests).
            7. If valid:
               `git commit -am "Apply review suggestions from conversation ${thread_id}" && git push`.
            8. Comment confirmation:
               `gh pr comment $PR_NUMBER --body "Applied all actionable suggestions from this conversation."`

            ## Rules
            - Only apply precise, safe, local edits.
            - Ignore abstract or unclear feedback.
            - Do not merge PR.
            - Keep atomic commits and concurrency safe.

  maintenance:
    if: github.event_name == 'schedule'  
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    defaults:
      run:
        shell: bash
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: "Run iFlow CLI for Repository Maintenance"
        uses: iflow-ai/iflow-cli-action@v2.1.0
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
          REPOSITORY: ${{ github.repository }}
        with:
          api_key: ${{ secrets.IFLOW_API_KEY }}
          timeout: '10800'
          prompt: |
            ## Role
            You are an AI maintainer ensuring long-term health and security.

            ## Tasks
            - Scan, refactor, update dependencies safely.
            - Commit to `iflow/maintenance/${{ github.run_id }}` and open PR.
