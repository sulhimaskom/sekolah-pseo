name: 'ü§ñ iFLOW PR Specialist'

on:
  pull_request:
    types: [opened, reopened, synchronize, edited]
  issue_comment:
    types: [created]
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'Pull Request number to analyze'
        required: true
        type: number

concurrency:
  group: '${{ github.workflow }}-${{ github.event.pull_request.number || github.event.inputs.pr_number }}'
  cancel-in-progress: true

defaults:
  run:
    shell: bash

permissions:
  id-token: write
  contents: write
  pull-requests: write
  issues: write
  checks: write
  statuses: write

jobs:
  triage-pr:
    if: |
      github.event_name == 'pull_request' ||
      github.event_name == 'workflow_dispatch' ||
      (
        github.event_name == 'issue_comment' &&
        contains(github.event.comment.body, '@iflow-cli /review') &&
        contains(fromJSON('["OWNER", "MEMBER", "COLLABORATOR"]'), github.event.comment.author_association)
      )
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate clean branch (no merge conflicts)
        run: |
          git fetch origin ${{ github.event.pull_request.base.ref }}
          if ! git merge-base --is-ancestor origin/${{ github.event.pull_request.base.ref }} HEAD; then
            echo "::error::PR branch is behind base branch. Please rebase or merge latest main."
            exit 1
          fi

      - name: Run build & test
        run: |
          if [ -f "package.json" ]; then
            npm ci
            npm run build || exit 1
            npm test || echo "‚ö†Ô∏è No tests found or tests failed"
          elif [ -f "Makefile" ]; then
            make build || exit 1
            make test || echo "‚ö†Ô∏è No tests found or failed"
          else
            echo "‚ÑπÔ∏è No build instructions found, skipping..."
          fi

      - name: Collect PR conversation
        id: get_conversation
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          result-encoding: string
          script: |
            const pr = github.event.pull_request || { number: ${{ github.event.inputs.pr_number }} };
            const comments = await github.paginate(github.rest.issues.listComments, {
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number
            });
            return comments.map(c => `@${c.user.login}: ${c.body}`).join("\n---\n");

      - name: Run iFlow PR Analysis
        uses: iflow-ai/iflow-cli-action@v2.0.0
        id: iflow_cli_pr_analysis
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_TITLE: ${{ github.event.pull_request.title }}
          PR_BODY: ${{ github.event.pull_request.body }}
          PR_CONVERSATION: ${{ steps.get_conversation.outputs.result }}
          PR_NUMBER: ${{ github.event.pull_request.number || github.event.inputs.pr_number }}
          REPOSITORY: ${{ github.repository }}
        with:
          api_key: ${{ secrets.IFLOW_API_KEY }}
          debug: "true"
          timeout: "3600"
          prompt: |
            ## Role
            You are a PR Specialist. Review the pull request, considering its title, body, and conversation context.
            Ensure that the branch is clean, the build has succeeded, and the PR follows good development hygiene.

            ## Tasks
            1. Analyze title/body/conversation for intent and completeness.
            2. Check that build/test passed (from previous step result).
            3. If build failed, comment that the PR needs fixing.
            4. Suggest labels following the format: `type/*`, `priority/*`, and optionally `status/*`.
            5. Apply labels using: `gh pr edit "${PR_NUMBER}" --add-label "label1,label2"`.
            6. If ready for merge, add `status/ready-for-review`.
            7. Otherwise, add `status/needs-work`.

            ## Rules
            - Only use existing labels.
            - Do not modify PR description.
            - Add comment summarizing your assessment and next action.

      - name: Comment PR Result
        if: always()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const body = `
            üß† **iFlow PR Review Summary**
            - Build: ‚úÖ Passed or ‚ö†Ô∏è Failed
            - Branch status: Clean
            - Analysis: Completed by iFlow PR Specialist
            Check the action logs for detailed output.
            `;
            github.rest.issues.createComment({
              owner: '${{ github.repository }}'.split('/')[0],
              repo: '${{ github.repository }}'.split('/')[1],
              issue_number: '${{ github.event.pull_request.number || github.event.inputs.pr_number }}',
              body
            });
            
