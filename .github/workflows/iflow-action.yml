name: '‚öôÔ∏è iFLOW GitHub Action Specialist'

on:
  push:
    paths:
      - '.github/workflows/*.yml'
      - '.github/workflows/*.yaml'
  pull_request:
    paths:
      - '.github/workflows/*.yml'
      - '.github/workflows/*.yaml'
  issue_comment:
    types: [created]
  workflow_dispatch:
    inputs:
      file_path:
        description: 'Path to workflow file for review'
        required: false
        type: string

concurrency:
  group: '${{ github.workflow }}-${{ github.event.pull_request.number || github.sha }}'
  cancel-in-progress: true

permissions:
  contents: write
  pull-requests: write
  issues: write

defaults:
  run:
    shell: bash

jobs:
  analyze-workflow:
    if: |
      github.event_name == 'push' ||
      github.event_name == 'pull_request' ||
      (
        github.event_name == 'issue_comment' &&
        contains(github.event.comment.body, '@iflow-cli /analyze') &&
        contains(fromJSON('["OWNER","MEMBER","COLLABORATOR"]'), github.event.comment.author_association)
      )
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Collect workflow context
        id: collect
        run: |
          mkdir -p tmp
          echo "üîç Collecting workflow files..."
          ls .github/workflows > tmp/list.txt || echo "No workflows found"
          echo "list=$(cat tmp/list.txt | tr '\n' ', ')" >> $GITHUB_OUTPUT

      - name: Get changed workflow
        id: changed
        run: |
          FILE="${{ github.event.inputs.file_path || github.event.pull_request.head.sha }}"
          CHANGED=$(git diff --name-only HEAD~1 | grep '.github/workflows/' || true)
          echo "changed=${CHANGED}" >> $GITHUB_OUTPUT

      - name: Fetch repository workflows content
        id: workflow_data
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          result-encoding: string
          script: |
            const files = await github.paginate(github.rest.repos.getContent, {
              owner: context.repo.owner,
              repo: context.repo.repo,
              path: ".github/workflows"
            });
            const data = [];
            for (const f of files) {
              if (f.type === "file" && f.name.endsWith(".yml") || f.name.endsWith(".yaml")) {
                const res = await github.request(`GET ${f.download_url}`);
                data.push(`### ${f.name}\n${res.data}`);
              }
            }
            return data.join("\n\n");

      - name: Run iFlow Workflow Intelligence
        uses: iflow-ai/iflow-cli-action@v2.1.0
        id: iflow_github_action_specialist
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          WORKFLOW_FILES: ${{ steps.workflow_data.outputs.result }}
          CHANGED_FILES: ${{ steps.changed.outputs.changed }}
          REPOSITORY: ${{ github.repository }}
          BRANCH: ${{ github.ref_name }}
          ACTOR: ${{ github.actor }}
        with:
          api_key: ${{ secrets.IFLOW_API_KEY }}
          timeout: "36000"
          prompt: |
            ## Role
            You are a GitHub Action Specialist ‚Äî an intelligent automation engineer.
            Your task: analyze and evolve workflows intelligently, learning from existing ones.
            Use reasoning to detect inefficiency, outdated patterns, redundant triggers, and security risks.

            ## Behavior
            - You continuously improve based on the repository‚Äôs full workflow history.
            - You learn common practices from this repo to maintain consistent CI/CD style.
            - You adapt: if the repo evolves, your suggestions evolve too.
            - Your analysis must be **executable**, not just theoretical.

            ## Steps
            1. Read all workflows from WORKFLOW_FILES.
            2. Focus on CHANGED_FILES to identify modifications.
            3. Check syntax, performance, permissions, concurrency, caching, and reusability.
            4. Recommend improvements (e.g., reusable workflow, job matrix, conditionals).
            5. If insecure patterns exist (unscoped tokens, unpinned actions), flag them.
            6. Post structured feedback as a comment in the PR:
               - ‚úÖ What‚Äôs correct
               - ‚öôÔ∏è What can be optimized
               - üö® What must be fixed
               - üí° Optional enhancement ideas

            ## Output Format
            ```
            ‚úÖ Summary
            - key insights...

            ‚öôÔ∏è Recommendations
            - improvement 1
            - improvement 2

            üö® Issues
            - critical 1

            üí° Ideas
            - idea 1
            ```
            - Keep concise but technical.
            - Do not modify repo files directly.
            - Always reference workflow filenames.

      - name: Post Specialist Feedback
        if: always()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const pr = context.payload.pull_request;
            const number = pr ? pr.number : (context.issue.number || null);
            if (!number) return;
            const body = `
            ü§ñ **iFlow GitHub Action Specialist Report**

            Workflow files analyzed:  
            \`${{ steps.collect.outputs.list }}\`

            Result generated by AI workflow engineer.  
            Check the logs for learning context and reasoning.
            `;
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: number,
              body
            });
