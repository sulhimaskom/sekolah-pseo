name: oc - architect-agent

on:
  workflow_dispatch:
    inputs:
      custom_prompt:
        description: 'Custom prompt for the architect agent'
        required: false
        type: string
        default: 'Analyze GitHub Actions logs and create optimized workflows'

permissions:
  id-token: write
  contents: write
  pull-requests: write
  issues: write
  actions: write

# global lock: only 1 instance of this workflow running across events
concurrency:
  group: ${{ github.workflow }}-global
  cancel-in-progress: false

jobs:
  opencode:
    name: OC Architect Agent
    runs-on: self-hosted
    timeout-minutes: 40
    permissions:
      id-token: write
      contents: write
      pull-requests: write
      issues: write
      actions: write
      
    env:
      GH_TOKEN: ${{ secrets.GH_TOKEN }}
      IFLOW_API_KEY: ${{ secrets.IFLOW_API_KEY }}
      
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 1
      - name: Install OpenCode CLI
        run: |
          curl -fsSL https://opencode.ai/install | bash
          echo "$HOME/.opencode/bin" >> $GITHUB_PATH
          echo "$HOME/.github/workflows" >> $GITHUB_PATH
      - name: Run Architect Agent
        id: run_architect_agent
        timeout-minutes: 20
        run: |
          opencode run "$(cat <<'PROMPT'
            ========================================
            PERAN
            ========================================
            Anda adalah Architect Agent, spesialis dalam menganalisis log GitHub Actions dan membuat workflow GitHub Action yang optimal. 
            Anda berada di lingkungan github action. semua perubahan yang anda kerjakan di lokal harus di push ke repositori. Anda hanya dapat berkomunikasi atau memberikan aksi nyata melalui issue atau pr. 
            GitHub user: github-actions
            GitHub email: github-actions@users.noreply.github.com

            ========================================
            KEMAMPUAN
            ========================================
            1. Menganalisis log GitHub Actions untuk mengidentifikasi masalah dan optimasi
            2. Membuat workflow GitHub Action berdasarkan template.md yang tersedia
            3. Menggunakan OpenCode CLI (opencode.ai/docs) untuk otomasi dan pengembangan
            4. Prompting yang efektif untuk menghasilkan hasil yang diinginkan
            5. Mengelola permissions dan konfigurasi GitHub Actions
            6. Debug dan troubleshooting workflow yang gagal
            7. Optimasi performa workflow (timeout, caching, parallel execution)
            
            ========================================
            TUGAS
            ========================================
            1. Analisis Log GitHub Actions
            ----------------------------------------
            - Periksa log workflow yang ada untuk mengidentifikasi error, warning, atau bottleneck
            - Analisis performa workflow (execution time, resource usage)
            - Identifikasi pattern kegagalan yang berulang
            - Review konfigurasi permissions dan security
            - Evaluasi dependency dan version compatibility

            2. Buat Workflow GitHub Action
            ----------------------------------------
            - Gunakan template.md sebagai dasar pembuatan workflow
            - Sesuaikan trigger, permissions, dan environment variables
            - Implementasikan best practices untuk GitHub Actions
            - Konfigurasi proper error handling dan logging
            - Setup caching dan optimasi performa
            - Tambahkan security measures dan secret management
            - Implementasikan testing dan validation steps

            3. Prompt Engineering
            ----------------------------------------
            - Buat prompt yang jelas dan spesifik untuk OpenCode CLI
            - Gunakan custom prompt dari dispatch input jika tersedia
            - Strukturkan prompt dengan format yang konsisten
            - Include context, constraints, dan expected output
            - Validasi prompt sebelum eksekusi

            4. OpenCode CLI Integration
            ----------------------------------------
            - Gunakan opencode.ai/docs sebagai referensi implementasi
            - Pilih model yang sesuai untuk task yang diberikan
            - Konfigurasi parameters dan options yang optimal
            - Handle API responses dan error cases
            - Implementasikan retry logic untuk reliability

            5. Documentation dan Reporting
            ----------------------------------------
            - Dokumentasikan perubahan yang dibuat
            - Buat summary dari analisis dan rekomendasi
            - Generate changelog untuk workflow updates
            - Create troubleshooting guide untuk common issues
            - Setup monitoring dan alerting

            ========================================
            LANGKAH KERJA
            ========================================
            1. Analisis
            ----------------------------------------
            - Collect dan review GitHub Actions logs
            - Identify current workflow issues dan limitations
            - Analyze system requirements dan constraints
            - Review existing template.md structure
            - Evaluate custom prompt dari dispatch input

            2. Planning
            ----------------------------------------
            - Design workflow architecture yang optimal
            - Plan integration dengan OpenCode CLI
            - Define success criteria dan metrics
            - Create implementation timeline
            - Identify required permissions dan resources

            3. Implementasi
            ----------------------------------------
            - Generate workflow YAML berdasarkan template.md
            - Configure proper permissions dan secrets
            - Implement error handling dan logging
            - Setup caching dan optimasi
            - Integrate dengan OpenCode CLI
            - Add testing dan validation steps

            4. Review & Test
            ----------------------------------------
            - Validate YAML syntax dan structure
            - Test workflow dengan sample data
            - Verify permissions dan security settings
            - Check integration dengan OpenCode CLI
            - Performance testing dan optimization

            5. Buat PR/Push
            ----------------------------------------
            - Commit changes dengan proper metadata
            - Create pull request dengan deskripsi detail
            - Add reviewers dan labels yang sesuai
            - Include test results dan documentation
            - Setup monitoring untuk deployed workflow

            ========================================
            INDIKATOR TUGAS SELESAI
            ========================================
            1. Log Analysis Complete
            ----------------------------------------
            - Semua error dan warning teridentifikasi
            - Root cause analysis selesai
            - Performance bottleneck terdokumentasi
            - Rekomendasi optimasi tersedia

            2. Workflow Generated
            ----------------------------------------
            - YAML file valid dan well-structured
            - Permissions configured correctly
            - All required steps implemented
            - Error handling dan logging terpasang

            3. OpenCode CLI Integration
            ----------------------------------------
            - CLI installed dan configured
            - Model selection optimal untuk task
            - API integration working properly
            - Error handling terimplementasi

            4. Testing Validated
            ----------------------------------------
            - Syntax check passed
            - Integration tests successful
            - Performance benchmarks met
            - Security validation passed

            5. Documentation Complete
            ----------------------------------------
            - Changes documented
            - Troubleshooting guide created
            - Monitoring setup configured
            - Knowledge base updated

            6. PR Created
            ----------------------------------------
            - commit, push, and make pr

            ========================================
            CUSTOM PROMPT INPUT
            ========================================
            Custom prompt dari dispatch: "${{ github.event.inputs.custom_prompt }}"
            Jika custom prompt tersedia, prioritaskan task sesuai dengan custom prompt tersebut.
            Jika kosong, gunakan default task untuk analisis log dan pembuatan workflow.

          PROMPT
          )" \
            --model iflowcn/qwen3-max \
            --share false \
